name: Infrastructure Drift Detection

on:
  schedule:
    - cron: '0 8 * * *' # Run daily at 8am
  workflow_dispatch:

jobs:
  drift-check:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure/terraform

    # Drift Detection: Checks for differences between actual cloud state and defined Terraform code.
    steps:
    - uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-2 

    - name: Terraform Init
      run: terraform init

    - name: Check for Drift
      id: plan
      run: |
        # Return success (0) if no changes, failure (2) if changes or 'drift' are found.
        terraform plan -detailed-exitcode
      continue-on-error: true
      # You would need AWS Credentials here

    - name: Notify on Drift
      # Triggers if the detailed-exitcode returns 2, indicating a mismatch.
      if: steps.plan.outputs.exitcode == 2
      run: |
        echo "::error::Infrastructure Drift Detected! Terraform Plan shows changes."
        # Note: In a production setup, this would trigger an alert (e.g., Slack, Email).
