name: ShopMicro CD

on:
  workflow_run:
    workflows: ["ShopMicro CI"]
    types: [completed]
    branches: [main]

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubeconfig
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify Cluster Connection
        run: |
          kubectl cluster-info

      - name: Update Image Tags
        run: |
          SHA_TAG="sha-$(git rev-parse --short HEAD)"
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          sed -i "s|image: .*shopmicro-backend:.*|image: ghcr.io/${REPO_LOWER}-backend:${SHA_TAG}|g" k8s/backend.yaml
          sed -i "s|image: .*shopmicro-frontend:.*|image: ghcr.io/${REPO_LOWER}-frontend:${SHA_TAG}|g" k8s/frontend.yaml
          sed -i "s|image: .*shopmicro-ml-service:.*|image: ghcr.io/${REPO_LOWER}-ml-service:${SHA_TAG}|g" k8s/ml-service.yaml

          sed -i 's/imagePullPolicy: Never/imagePullPolicy: IfNotPresent/g' k8s/backend.yaml
          sed -i 's/imagePullPolicy: Never/imagePullPolicy: IfNotPresent/g' k8s/frontend.yaml
          sed -i 's/imagePullPolicy: Never/imagePullPolicy: IfNotPresent/g' k8s/ml-service.yaml

      - name: Deploy Namespace
        run: kubectl apply -f k8s/namespace.yaml

      - name: Deploy Postgres
        run: |
          kubectl apply -f k8s/postgres.yaml
          echo "Waiting for Postgres to be ready..."
          kubectl wait --for=condition=Ready pod -l app=postgres -n shopmicro --timeout=180s

      - name: Deploy Backend
        run: |
          kubectl apply -f k8s/backend.yaml
          echo "Waiting for Backend to be ready..."
          kubectl rollout status deployment/backend -n shopmicro --timeout=180s

      - name: Deploy ML Service
        run: |
          kubectl apply -f k8s/ml-service.yaml
          echo "Waiting for ML Service to be ready..."
          kubectl rollout status deployment/ml-service-deployment -n shopmicro --timeout=180s

      - name: Deploy Frontend
        run: |
          kubectl apply -f k8s/frontend.yaml
          echo "Waiting for Frontend to be ready..."
          kubectl rollout status deployment/frontend -n shopmicro --timeout=180s

      - name: Deploy Observability & Other Services
        run: |
          kubectl apply -f k8s/grafana.yaml
          kubectl apply -f k8s/redis.yaml
          kubectl apply -f k8s/ingress.yaml
          kubectl apply -f k8s/observability/dashboards.yaml
          kubectl apply -f k8s/observability/grafana-datasources.yaml
          kubectl apply -f k8s/observability/loki.yaml
          kubectl apply -f k8s/observability/prometheus.yaml
          kubectl apply -f k8s/observability/prometheus-rules.yaml
          kubectl apply -f k8s/observability/tempo.yaml
