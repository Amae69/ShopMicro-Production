name: ShopMicro CD

on:
  workflow_run:
    workflows: ["ShopMicro CI"]
    types: [completed]
    branches: [main]

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update Kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      - name: Verify Cluster Connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Update Image Tags
        run: |
          SHA_TAG="sha-$(git rev-parse --short HEAD)"
          
          # Directly replace the placeholder string in all manifests
          # This is more robust than matching against repo names
          sed -i "s|\${SHA_TAG}|${SHA_TAG}|g" k8s/backend.yaml
          sed -i "s|\${SHA_TAG}|${SHA_TAG}|g" k8s/frontend.yaml
          sed -i "s|\${SHA_TAG}|${SHA_TAG}|g" k8s/ml-service.yaml

          # Ensure ImagePullPolicy is set to IfNotPresent
          sed -i 's/imagePullPolicy: .*/imagePullPolicy: IfNotPresent/g' k8s/backend.yaml
          sed -i 's/imagePullPolicy: .*/imagePullPolicy: IfNotPresent/g' k8s/frontend.yaml
          sed -i 's/imagePullPolicy: .*/imagePullPolicy: IfNotPresent/g' k8s/ml-service.yaml

      - name: Deploy Namespace
        run: kubectl apply -f k8s/namespace.yaml

      - name: Deploy Secrets
        run: kubectl apply -f k8s/secrets.yaml.template

      - name: Deploy Postgres
        run: |
          # Proactively delete PVCs using the old 'local-path' storage class if they exist
          # This prevents the pod from getting stuck on an unsupported volume
          echo "Checking for old 'local-path' PVCs..."
          if kubectl get pvc -n shopmicro -o json | jq -e '.items[] | select(.spec.storageClassName=="local-path")' > /dev/null; then
            echo "Found poisoned PVCs with 'local-path'. Deleting..."
            kubectl delete pvc -l app=postgres -n shopmicro --ignore-not-found
            echo "Deleting existing StatefulSet to force fresh volume binding..."
            kubectl delete statefulset postgres -n shopmicro --ignore-not-found
          fi

          # Attempt to apply, if it fails due to immutable fields in StatefulSet, recreate it
          if ! kubectl apply -f k8s/postgres.yaml; then
            echo "Apply failed, attempting to delete and recreate StatefulSet..."
            kubectl delete statefulset postgres -n shopmicro --ignore-not-found
            kubectl delete pvc -l app=postgres -n shopmicro --ignore-not-found
            kubectl apply -f k8s/postgres.yaml
          fi
          
          echo "Waiting for Postgres to be ready..."
          if ! kubectl wait --for=condition=Ready pod -l app=postgres -n shopmicro --timeout=300s; then
            echo "--- DIAGNOSTICS START ---"
            echo "--- Pod Description ---"
            kubectl describe pods -l app=postgres -n shopmicro
            echo "--- Events ---"
            kubectl get events -n shopmicro --sort-by='.lastTimestamp'
            echo "--- PVC Status ---"
            kubectl get pvc -n shopmicro
            kubectl describe pvc -n shopmicro
            echo "--- Storage Classes ---"
            kubectl get sc
            echo "--- Pod Logs ---"
            kubectl logs -l app=postgres -n shopmicro --all-containers --tail=100
            echo "--- DIAGNOSTICS END ---"
            exit 1
          fi

      - name: Deploy Backend
        run: |
          kubectl apply -f k8s/backend.yaml
          echo "Waiting for Backend to be ready..."
          if ! kubectl rollout status deployment/backend -n shopmicro --timeout=180s; then
            echo "--- BACKEND DIAGNOSTICS START ---"
            kubectl describe pods -l app=backend -n shopmicro
            kubectl logs -l app=backend -n shopmicro --all-containers --tail=100
            echo "--- BACKEND DIAGNOSTICS END ---"
            exit 1
          fi

      - name: Deploy ML Service
        run: |
          kubectl apply -f k8s/ml-service.yaml
          echo "Waiting for ML Service to be ready..."
          if ! kubectl rollout status deployment/ml-service-deployment -n shopmicro --timeout=180s; then
            echo "--- ML SERVICE DIAGNOSTICS START ---"
            kubectl describe pods -l app=ml-service -n shopmicro
            kubectl logs -l app=ml-service -n shopmicro --all-containers --tail=100
            echo "--- ML SERVICE DIAGNOSTICS END ---"
            exit 1
          fi

      - name: Deploy Frontend
        run: |
          kubectl apply -f k8s/frontend.yaml
          echo "Waiting for Frontend to be ready..."
          if ! kubectl rollout status deployment/frontend -n shopmicro --timeout=180s; then
            echo "--- FRONTEND DIAGNOSTICS START ---"
            kubectl describe pods -l app=frontend -n shopmicro
            kubectl logs -l app=frontend -n shopmicro --all-containers --tail=100
            echo "--- FRONTEND DIAGNOSTICS END ---"
            exit 1
          fi

      - name: Deploy Observability & Other Services
        run: |
          kubectl apply -f k8s/grafana.yaml
          kubectl apply -f k8s/redis.yaml
          kubectl apply -f k8s/ingress.yaml
          kubectl apply -f k8s/observability/dashboards.yaml
          kubectl apply -f k8s/observability/grafana-datasources.yaml
          kubectl apply -f k8s/observability/loki.yaml
          kubectl apply -f k8s/observability/prometheus.yaml
          kubectl apply -f k8s/observability/prometheus-rules.yaml
          kubectl apply -f k8s/observability/tempo.yaml
          
          echo "Waiting for Loki to be ready..."
          if ! kubectl rollout status deployment/loki -n shopmicro --timeout=60s; then
            echo "--- LOKI DIAGNOSTICS START ---"
            kubectl describe pods -l app=loki -n shopmicro
            kubectl logs -l app=loki -n shopmicro --tail=100
            echo "--- LOKI DIAGNOSTICS END ---"
          fi

          echo "Waiting for Tempo to be ready..."
          if ! kubectl rollout status deployment/tempo -n shopmicro --timeout=60s; then
            echo "--- TEMPO DIAGNOSTICS START ---"
            kubectl describe pods -l app=tempo -n shopmicro
            kubectl logs -l app=tempo -n shopmicro --tail=100
            echo "--- TEMPO DIAGNOSTICS END ---"
          fi
