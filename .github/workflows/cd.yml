name: ShopMicro CD

on:
  workflow_run:
    workflows: ["ShopMicro CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: development
    
    steps:
      - uses: actions/checkout@v3

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          # Create config from secret
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          
          # If the user provided a MASTER_IP secret, force-replace it in the config
          # This helps if the KUBECONFIG secret still has the old private IP
          if [ ! -z "${{ secrets.K8S_MASTER_IP }}" ]; then
            sed -i "s|https://.*:6443|https://${{ secrets.K8S_MASTER_IP }}:6443|g" ~/.kube/config
          fi
          
          chmod 600 ~/.kube/config

      - name: Update Image Tags
        run: |
          SHA_TAG="sha-$(git rev-parse --short HEAD)"
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # Update image names with lowercased repository
          sed -i "s|image: .*shopmicro-backend:.*|image: ghcr.io/${REPO_LOWER}-backend:${SHA_TAG}|g" k8s/backend.yaml
          sed -i "s|image: .*shopmicro-frontend:.*|image: ghcr.io/${REPO_LOWER}-frontend:${SHA_TAG}|g" k8s/frontend.yaml
          sed -i "s|image: .*shopmicro-ml-service:.*|image: ghcr.io/${REPO_LOWER}-ml-service:${SHA_TAG}|g" k8s/ml-service.yaml
          
          # Ensure imagePullPolicy is IfNotPresent
          sed -i 's/imagePullPolicy: Never/imagePullPolicy: IfNotPresent/g' k8s/backend.yaml
          sed -i 's/imagePullPolicy: Never/imagePullPolicy: IfNotPresent/g' k8s/frontend.yaml
          sed -i 's/imagePullPolicy: Never/imagePullPolicy: IfNotPresent/g' k8s/ml-service.yaml

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/namespace.yaml --validate=false --insecure-skip-tls-verify
          kubectl apply -f k8s/backend.yaml --validate=false --insecure-skip-tls-verify
          kubectl apply -f k8s/frontend.yaml --validate=false --insecure-skip-tls-verify
          kubectl apply -f k8s/ml-service.yaml --validate=false --insecure-skip-tls-verify
          kubectl apply -f k8s/grafana.yaml --validate=false --insecure-skip-tls-verify
          kubectl apply -f k8s/postgres.yaml --validate=false --insecure-skip-tls-verify
          kubectl apply -f k8s/redis.yaml --validate=false --insecure-skip-tls-verify
          kubectl apply -f k8s/ingress.yaml --validate=false --insecure-skip-tls-verify
          # Apply other manifests as needed
          
      - name: Verify Deployment
        run: |
          kubectl rollout status deployment/backend -n shopmicro --timeout=180s --insecure-skip-tls-verify
          kubectl rollout status deployment/frontend -n shopmicro --timeout=180s --insecure-skip-tls-verify
          kubectl rollout status deployment/ml-service-deployment -n shopmicro --timeout=180s --insecure-skip-tls-verify
