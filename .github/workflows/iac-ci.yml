name: Infrastructure CI

on:
  pull_request:
    paths:
      - 'infrastructure/terraform/**'

jobs:
  terraform-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure/terraform

    steps:
    - uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1 # Adjust to your region if different

    - name: Terraform Format Check
      run: terraform fmt -check -recursive

    - name: Terraform Init
      run: terraform init -backend=false

    - name: Terraform Validate
      run: terraform validate

    - name: Setup TFLint
      uses: terraform-linters/setup-tflint@v3
      with:
        tflint_version: v0.44.1

    - name: Run TFLint
      run: tflint --init && tflint

    - name: Terraform Plan
      id: plan
      run: terraform plan -out=tfplan.binary
      # Note: This requires AWS credentials to be configured in env/secrets

    - name: Convert Plan to JSON
      if: steps.plan.outcome == 'success'
      run: terraform show -json tfplan.binary > tfplan.json

    - name: Install OPA
      if: steps.plan.outcome == 'success'
      run: |
        curl -L -o opa https://openpolicyagent.org/downloads/v0.54.0/opa_linux_amd64_static
        chmod 755 ./opa

    - name: Run OPA Policies (Policy as Code)
      if: steps.plan.outcome == 'success'
      run: ./opa eval --data policies/main.rego --input tfplan.json "data.terraform.analysis.deny" --format pretty
